name: Kaggle Notebook Executor

on:
  workflow_dispatch:
  repository_dispatch:
    types: [cron-trigger]

jobs:
  execute-notebooks:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        pip install kaggle
    
    - name: Execute notebooks
      run: |
        python << 'PYEOF'
        import os
        import subprocess
        import json
        import sys
        from datetime import datetime
        from pathlib import Path
        import shutil
        import time

        SOURCE_ACCOUNT = {
            "username": "shreevathsbbhh",
            "key": "9f167cdee8a045c97ca6a2f82c6701f9"
        }

        DEST_ACCOUNTS = {
            "distinct4exist": {
                "username": "distinct4exist",
                "key": "c2767798395ca8c007e931d6f9d42752"
            },
            "shreevathsaz": {
                "username": "shreevathsaz",
                "key": "2faa3199cb4f8a0d88a8999604ac6770"
            }
        }

        NOTEBOOKS = [
            {
                "source_slug": "shreevathsbbhh/new-20-1", 
                "notebook_name": "new-20-1", 
                "dest_slug": "shreevathsaz/new-20-1",
                "dest_account": "shreevathsaz"
            },
            {
                "source_slug": "shreevathsbbhh/war-2", 
                "notebook_name": "war-2", 
                "dest_slug": "distinct4exist/war-2",
                "dest_account": "distinct4exist"
            },
            {
                "source_slug": "shreevathsbbhh/war-1",   
                "notebook_name": "war-1",   
                "dest_slug": "distinct4exist/war-1",
                "dest_account": "distinct4exist"
            }
        ]

        def log(msg, symbol="â„¹ï¸"):
            timestamp = datetime.utcnow().strftime('%H:%M:%S')
            print(f"[{timestamp}] {symbol} {msg}")
            sys.stdout.flush()

        def setup_kaggle_auth(account):
            kaggle_dir = Path.home() / ".kaggle"
            kaggle_dir.mkdir(exist_ok=True)
            kaggle_json = kaggle_dir / "kaggle.json"
            with open(kaggle_json, 'w') as f:
                json.dump({"username": account["username"], "key": account["key"]}, f)
            kaggle_json.chmod(0o600)
            log(f"Auth set: {account['username']}", "ðŸ”‘")

        def run_cmd(cmd, timeout=180):
            try:
                result = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=timeout)
                return result.returncode == 0, result.stdout, result.stderr
            except subprocess.TimeoutExpired:
                return False, "", "Timeout"
            except Exception as e:
                return False, "", str(e)

        def kernel_exists(dest_slug, account):
            """Check if kernel exists on destination account"""
            setup_kaggle_auth(account)
            time.sleep(0.3)
            success, stdout, stderr = run_cmd(f"kaggle kernels status {dest_slug}")
            exists = success and "404" not in stderr and "not found" not in stderr.lower()
            log(f"Kernel exists check ({dest_slug}): {exists}", "ðŸ”")
            return exists

        def execute_notebook(nb):
            log(f"START: {nb['notebook_name']} â†’ {nb['dest_account']}", "ðŸš€")
            
            temp_dir = Path(f"./temp_{nb['notebook_name']}")
            original_dir = os.getcwd()
            
            try:
                if temp_dir.exists():
                    shutil.rmtree(temp_dir)
                temp_dir.mkdir()
                
                target_account_key = nb['dest_account']
                dest_account = DEST_ACCOUNTS[target_account_key]
                
                # Check if kernel already exists on destination
                exists = kernel_exists(nb['dest_slug'], dest_account)
                
                # Pull from source
                setup_kaggle_auth(SOURCE_ACCOUNT)
                time.sleep(0.3)
                
                log(f"Pulling {nb['notebook_name']}...", "ðŸ“¥")
                success, stdout, stderr = run_cmd(f"kaggle kernels pull {nb['source_slug']} -p {temp_dir} -m")
                
                if not success:
                    log(f"PULL FAILED: {stderr[:300]}", "âŒ")
                    return False
                
                log(f"Pull OK", "âœ…")
                
                # Update metadata
                metadata_file = temp_dir / "kernel-metadata.json"
                if not metadata_file.exists():
                    log(f"MISSING metadata", "âŒ")
                    return False
                
                with open(metadata_file, 'r') as f:
                    metadata = json.load(f)
                
                log(f"Original ID: {metadata.get('id', 'N/A')}", "ðŸ“")
                
                new_slug = nb['dest_slug'].split('/')[-1]
                
                if exists:
                    # Kernel exists - set ID to push new version
                    metadata['id'] = nb['dest_slug']
                    metadata['slug'] = new_slug
                    metadata['title'] = nb['notebook_name']
                    log(f"Mode: NEW VERSION (kernel exists)", "ðŸ”„")
                else:
                    # Kernel doesn't exist - remove ID, let Kaggle create new
                    metadata.pop('id', None)  # Remove id field
                    metadata['slug'] = new_slug
                    metadata['title'] = nb['notebook_name']
                    log(f"Mode: CREATE NEW (kernel doesn't exist)", "ðŸ†•")
                
                with open(metadata_file, 'w') as f:
                    json.dump(metadata, f, indent=2)
                
                log(f"Metadata updated: slug={new_slug}, title={nb['notebook_name']}", "ðŸ“")
                
                # Push to destination
                setup_kaggle_auth(dest_account)
                time.sleep(0.3)
                
                os.chdir(temp_dir)
                
                log(f"Pushing...", "ðŸ“¤")
                success, stdout, stderr = run_cmd("kaggle kernels push", timeout=240)
                
                os.chdir(original_dir)
                
                if not success:
                    log(f"PUSH FAILED", "âŒ")
                    log(f"Error: {stderr[:400]}", "")
                    log(f"Output: {stdout[:400]}", "")
                    return False
                
                log(f"Push OK: {nb['notebook_name']}", "âœ…")
                log(f"URL: https://www.kaggle.com/code/{nb['dest_slug']}", "ðŸ”—")
                return True
                
            except Exception as e:
                log(f"EXCEPTION: {str(e)}", "âŒ")
                import traceback
                traceback.print_exc()
                return False
                
            finally:
                if os.getcwd() != original_dir:
                    os.chdir(original_dir)
                if temp_dir.exists():
                    shutil.rmtree(temp_dir, ignore_errors=True)

        def execute_all():
            start = datetime.utcnow()
            log(f"EXECUTION STARTED: {start.isoformat()}", "ðŸš€")
            log(f"Total notebooks: {len(NOTEBOOKS)}", "ðŸ“Š")
            
            results = {}
            
            for nb in NOTEBOOKS:
                log("â•" * 60, "")
                success = execute_notebook(nb)
                results[nb['notebook_name']] = success
                time.sleep(2)
            
            success_count = sum(results.values())
            duration = (datetime.utcnow() - start).total_seconds()
            
            log("â•" * 60, "")
            log(f"COMPLETED: {success_count}/{len(results)} | {duration:.1f}s", "ðŸ")
            
            for nb_name, success in results.items():
                log(f"{'âœ…' if success else 'âŒ'} {nb_name}", "")
            
            if success_count < len(results):
                sys.exit(1)

        execute_all()
        PYEOF
